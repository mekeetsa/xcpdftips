%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% ocgtooltip: A tooltip on a PDF layer using OCG (Optional Content Groups)
%             toggled by a mouse-click.
%
% v1.0 2019/03/15 Copyright (c) 2019 Mikica Kocic under GPLv3+
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <https://www.gnu.org/licenses/>.
%
% Credits: The code is based on "tooltips with LaTeX" by Alexander Grahn
%
% Warning: Requires pdfbase and ocgbase >= 2018/04/06
%
% Usage: ocgtooltip{<link text>}[<tooltip box color>]{<tooltip text>}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{pdfbase,ocgbase}
\usepackage{xparse}
\usepackage{expl3}
\usepackage{calc,linegoal}
\usepackage{xcolor}

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Check the required versions of pdfbase and ocgbase

\ExplSyntaxOn

\msg_set:nnnn{ocgtooltip}{support~outdated}{
  Support~package~`#1'~too~old.
}{
  Get~an~up~to~date~version~of~`#1'.\\Aborting.
}
\@ifpackagelater{pdfbase}{2018/04/06}{}{
  \msg_error:nnn{ocgtooltip}{support~outdated}{pdfbase.sty}
  \tex_endinput:D
}
\@ifpackagelater{ocgbase}{2018/04/06}{}{
  \msg_error:nnn{ocgtooltip}{support~outdated}{ocgbase.sty}
  \tex_endinput:D
}

\let\XC@pdfLink\pbs_pdflink:nn  % Alias for the pdflink from pdfbase

\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Patch hyperref (make the PDF annotations OCG-aware)

\let\Hy@setpdfborderOrig\Hy@setpdfborder
\def\Hy@setpdfborder{\ocgbase@insert@oc\Hy@setpdfborderOrig}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newsavebox{\XC@tipText}

\newcounter{XC@tipn}
\newlength{\XC@hGoal}
\newlength{\XC@hShift}
\newlength{\XC@hOffset} \setlength\XC@hOffset{-0.1em}
\newlength{\XC@vOffset} \setlength\XC@vOffset{0.2ex}

%\AtBeginShipout{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Command for showing tooltips. The arguments are the same as for \fcolorbox.
% Define \usetcolorbox to use tcolorbox instead of the default \fcolorbox.
% Use renewcommand to redefine.

\newcommand{\ocgtoolbox}[3]{%
  \ifx\usetcolorbox\undefined%
    \fcolorbox{#1}{#2}%
      {\parbox[t]{\columnwidth}{\normalfont\small #3}}%
  \else%
    \begin{tcolorbox}[colframe=#1,colback=#2,%
      width=1.02\columnwidth,arc=2pt,%
      boxsep=2pt,top=0ex,bottom=0ex,left=0.1em,right=0.1em%
      ]\normalfont\small #3\end{tcolorbox}%
  \fi%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NewDocumentCommand{\ocgtooltip}{%
  m % link text
  O{yellow!5} % tooltip box color
  m % tooltip text
}{{%
  \leavevmode%
  % Put the tooltip box on the new PDF layer
  \stepcounter{XC@tipn}%
  \ocgbase@new@ocg{xcite [\theXC@tipn]}{%
    /Print<</PrintState/OFF>> %
    /Export<</ExportState/OFF>> %
    /View<</ViewState/OFF>> %
  }{invisible}%
  \edef\XC@ocg{\ocgbase@last@ocg}%
  % Insert the PDF layer into order hierarchy (shown in the 'Layers' tab)
  \ocgbase@tree@node@begin%
  \XC@ocg%
  \ocgbase@tree@node@end%
  % Disable simultaneous visibility of multiple tooltips
  \ocgbase@add@ocg@to@radiobtn@grp{tool@tips}{\ocgbase@last@ocg}%
  % Emit the <link text> using \pbs_pdflink:nn
  \XC@pdfLink{%
    /Subtype/Link/Border[0 0 0]/A %
      <</S/SetOCGState/State [/Toggle \XC@ocg]>> %
  }{#1}%
  % Store the <tooltip text> on the ocg as a savebox
  \sbox\XC@tipText{%
    \ocgbase@oc@bdc{\XC@ocg}%
    \ocgbase@open@stack@push{\XC@ocg}%
      \ocgtoolbox{black!50}{#2}{#3}%
    \ocgbase@oc@emc%
    \ocgbase@open@stack@pop%
    \null%
  }%
  % Emit the savebox
  \raisebox{%
    \heightof{#1} + \the\dp\XC@tipText + \XC@vOffset%
  }[0pt][0pt]{%
    \makebox[0pt][l]{\relax%
      \setlength\XC@hGoal{\linegoal}%
      \setlength\XC@hShift{\XC@hGoal - \linewidth}%
      \hspace{\dimexpr\XC@hShift + \XC@hOffset \relax}%
      \usebox{\XC@tipText}%
    }%
  }%
}}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
