%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% ocgtooltip: A tooltip on a PDF layer (OCG), toggled on mouse-click
%             OCG = Optional Content Groups
%
% v1.0 2019/03/15 Copyright (c) 2019 Mikica Kocic under GPLv3+
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <https://www.gnu.org/licenses/>.
%
% Credits: The code is based on "tooltips with LaTeX" by Alexander Grahn
%
% Warning: Requires pdfbase and ocgbase >= 2018/04/06
%
% Usage:   ocgtooltip{<link text>}
%                    [<tooltip box color>]{<tooltip text>}
%                    [<x-offset>,<y-offset>]
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{pdfbase,ocgbase}[2018/04/06]
\usepackage{xparse}
\usepackage{calc,linegoal}
\usepackage{xcolor}

\makeatletter

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Patch hyperref (make the PDF annotations OCG-aware)

\let\Hy@setpdfborderOrig\Hy@setpdfborder
\def\Hy@setpdfborder{\ocgbase@insert@oc\Hy@setpdfborderOrig}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
\let\XC@pdfLink\pbs_pdflink:nn
\ExplSyntaxOff

\newsavebox{\XC@tipText}

\newcounter{XC@tipn}
\newlength{\XC@hGoal}
\newlength{\XC@hShift}
\newlength{\XC@hOffset} \setlength\XC@hOffset{-0.1em}
\newlength{\XC@vOffset} \setlength\XC@vOffset{0.2ex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NewDocumentCommand{\ocgtooltip}{%
  m % link text
  O{yellow!5} % tooltip box color
  m % tooltip text
}{{%
  \leavevmode%
  % Put the tooltip box on the new PDF layer
  \stepcounter{XC@tipn}%
  \ocgbase@new@ocg{XCiteTip.\theXC@tipn}{%
    /Print<</PrintState/OFF>> %
    /Export<</ExportState/OFF>> %
    /View<</ViewState/OFF>> %
  }{invisible}%
  \edef\XC@ocg{\ocgbase@last@ocg}%
  % Disable simultaneous visibility of multiple tooltips
  \ocgbase@add@ocg@to@radiobtn@grp{tool@tips}{\ocgbase@last@ocg}%
  % Emit the <link text> using \pbs_pdflink:nn
  \XC@pdfLink{%
    /Subtype/Link/Border[0 0 0]/A %
      <</S/SetOCGState/State [/Toggle \XC@ocg]>> %
  }{#1}%
  % Store the <tooltip text> as a savebox on the ocg
  \sbox\XC@tipText{%
    \ocgbase@oc@bdc{\XC@ocg}%
    \ocgbase@open@stack@push{\XC@ocg}%
      \fcolorbox{black}{#2}{#3}%
    \ocgbase@oc@emc%
    \ocgbase@open@stack@pop%
    \null%
  }%
  % Emit the savebox
  \raisebox{%
    \heightof{#1} + \the\dp\XC@tipText + \XC@vOffset%
  }[0pt][0pt]{%
    \makebox[0pt][l]{\relax%
      \setlength\XC@hGoal{\linegoal}%
      \setlength\XC@hShift{\XC@hGoal - \linewidth}%
      \hspace{\dimexpr\XC@hShift + \XC@hOffset \relax}%
      \usebox{\XC@tipText}%
    }%
  }%
}}

\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
